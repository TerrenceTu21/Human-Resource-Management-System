@model fyphrms.Models.Shared.MyProfileViewModel

@{
    ViewData["Title"] = "My Profile";
    Layout = "_Layout";
}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
<style>
    .profile-card {
        padding: 20px;
    }

    .profile-header {
        display: flex;
        align-items: center;
        border-bottom: 1px solid #eee;
        padding-bottom: 20px;
        margin-bottom: 20px;
    }

    .profile-picture {
        width: 90px;
        height: 90px;
        border-radius: 50%;
        object-fit: cover;
        margin-right: 20px;
        border: 3px solid #007bff;
        padding: 2px;
    }

    .profile-icon {
        font-size: 50px;
        margin-right: 20px;
        color: #6c757d;
        width: 90px;
        height: 90px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .detail-row {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 15px;
    }

    .detail-item {
        width: 100%;
        line-height: 1.6;
        padding-right: 15px;
    }

    @@media (min-width: 768px) {
        .detail-item {
            width: 50%;
        }
    }

    .detail-label {
        font-weight: 600;
        color: #6c757d;
        display: block;
        font-size: 0.85rem;
        margin-bottom: 2px;
    }

    .detail-value {
        color: #343a40;
        font-size: 1rem;
    }

    .section-header {
        border-bottom: 2px solid #007bff;
        padding-bottom: 5px;
        margin-bottom: 25px;
    }

    .fixed-top-right {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1050;
        max-width: 350px;
    }
</style>




<div class="container-fluid py-4">
    <div id="messageContainer"></div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-dark">My Profile</h2>
        <span class="text-secondary small">@DateTime.Now.ToString("dd MMMM yyyy")</span>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-body profile-card">

            <div class="profile-header">
                @if (!string.IsNullOrEmpty(Model.ProfilePicturePath))
                {
                    <img src="@Model.ProfilePicturePath" alt="Profile Picture" class="profile-picture" />
                }
                else
                {
                    <i class="fas fa-user-circle profile-icon"></i>
                }

                <div class="flex-grow-1">
                    <h4 class="mb-0 text-dark">@Model.FullName</h4>
                    <span class="text-primary font-weight-bold">@Model.PositionName</span>
                    <span class="text-muted ml-3">(@Model.EmployeeID)</span>
                </div>

                <div class="ml-auto">
                    <button type="button" class="btn btn-outline-primary btn-sm" data-toggle="modal" data-target="#editProfileModal">
                        <i class="fas fa-edit mr-1"></i> Edit Profile
                    </button>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-6 mb-4">
                    <h5 class="section-header">Personal Information</h5>
                    <div class="profile-details">

                        <div class="detail-row">
                            <div class="detail-item">
                                <span class="detail-label">@Html.DisplayNameFor(m => m.ICNumber):</span>
                                <span class="detail-value">@Model.ICNumber</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">@Html.DisplayNameFor(m => m.DateOfBirth):</span>
                                <span class="detail-value">@Model.DateOfBirth.ToString("yyyy-MM-dd")</span>
                            </div>
                        </div>

                        <div class="detail-row">
                            <div class="detail-item">
                                <span class="detail-label">@Html.DisplayNameFor(m => m.Email):</span>
                                <span class="detail-value"><a href="mailto:@Model.Email">@Model.Email</a></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">@Html.DisplayNameFor(m => m.ContactNumber):</span>
                                <span class="detail-value" id="contactValue">@Model.ContactNumber</span>
                            </div>
                        </div>

                        <div class="detail-row">
                            <div class="detail-item">
                                <span class="detail-label">@Html.DisplayNameFor(m => m.Gender):</span>
                                <span class="detail-value">@Model.Gender</span>
                            </div>
                        </div>

                        <div class="detail-row">
                            <div class="detail-item w-full">
                                <span class="detail-label">@Html.DisplayNameFor(m => m.Address):</span>
                                <span class="detail-value" id="addressValue">@Model.Address</span>
                            </div>
                        </div>

                    </div>
                </div>

                <div class="col-lg-6 mb-4">
                    <h5 class="section-header">Employment Information</h5>

                    <div class="profile-details">
                        <div class="detail-row">
                            <div class="detail-item">
                                <span class="detail-label">Department:</span>
                                <span class="detail-value">@Model.DepartmentName</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">@Html.DisplayNameFor(m => m.JoinDate):</span>
                                <span class="detail-value">@Model.JoinDate.ToString("yyyy-MM-dd")</span>
                            </div>
                        </div>

                        <div class="detail-row">
                            <div class="detail-item">
                                <span class="detail-label">Position:</span>
                                <span class="detail-value">@Model.PositionName</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">@Html.DisplayNameFor(m => m.EmploymentType):</span>
                                <span class="detail-value">@Model.EmploymentType</span>
                            </div>
                        </div>

                        <div class="detail-row">
                            <div class="detail-item">
                                <span class="detail-label">@Html.DisplayNameFor(m => m.BasicSalary):</span>
                                <span class="detail-value">@Model.BasicSalary.ToString("C")</span>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <h5 class="section-header mt-4">Quick Actions</h5>
            <div class="d-flex flex-wrap gap-3">
                @if (User.IsInRole("Employee"))
                {
                    <a href="/Employee/EmployeeLeaveApplication" class="btn btn-outline-success mr-2 mb-2">
                        <i class="fas fa-plane-departure mr-1"></i> Apply for Leave
                    </a>
                    <a href="/Employee/EmployeEClaimApplication" class="btn btn-outline-warning mr-2 mb-2">
                        <i class="fas fa-file-invoice-dollar mr-1"></i> Submit Claim
                    </a>
                }
                
                <a href="/Account/ChangePassword" class="btn btn-outline-primary mr-2 mb-2">
                    <i class="fas fa-key mr-1"></i> Change Password
                </a>

            </div>

        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Edit Information</h5>
            </div>

            <form id="editProfileForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="modalContactNumber">Phone Number</label>
                        <input type="tel" class="form-control" id="modalContactNumber" required>
                    </div>

                    <div class="form-group">
                        <label for="modalAddress">Address</label>
                        <textarea class="form-control" id="modalAddress" rows="3" required></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>

        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        
        const contactValueElement = document.getElementById('contactValue');
        const addressValueElement = document.getElementById('addressValue');

        
        const editForm = document.getElementById('editProfileForm');
        const modal = $('#editProfileModal');

        
        const employeeId = parseInt('@Model.EmployeeID', 10);

        
        function showCustomMessage(title, message, type) {
            const messageContainer = document.createElement('div');
            messageContainer.className = `alert alert-${type} alert-dismissible fade show fixed-top-right`;
            messageContainer.innerHTML = `
                <strong>${title}</strong> ${message}
                <span class="close" data-dismiss="alert" aria-label="Close" style="cursor:pointer;">&times;</span>
            `;
            document.body.appendChild(messageContainer);

            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                $(messageContainer).alert('close');
            }, 5000);
        }

        
        modal.on('shown.bs.modal', function () {
            const currentContact = contactValueElement;
            const currentAddress = addressValueElement ? addressValueElement.innerText.trim() : '';

            console.log("Pre-filling modal. Values read from main page:", { contact: currentContact, address: currentAddress });

            document.getElementById('modalContactNumber').value = currentContact;
            document.getElementById('modalAddress').value = currentAddress;

            document.getElementById('modalContactNumber').focus();
        });

        
        editForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            const newContact = document.getElementById('modalContactNumber').value.trim();
            const newAddress = document.getElementById('modalAddress').value.trim();
            const saveButton = editForm.querySelector('button[type="submit"]');

            if (!newContact || !newAddress) {
                showCustomMessage('Error!', 'Please fill in both Phone Number and Address fields.', 'danger');
                return;
            }

            
            saveButton.disabled = true;
            saveButton.innerHTML = '<span class="spinner-border spinner-border-sm mr-1" role="status" aria-hidden="true"></span> Saving...';

            try {
                const response = await fetch('/Account/UpdateContactDetails', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        EmployeeID: employeeId, 
                        ContactNumber: newContact,
                        Address: newAddress
                    })
                });

                if (!response.ok) {
                    const errorText = response.statusText || 'Server Error';
                    throw new Error(`HTTP error! Status: ${response.status} (${errorText})`);
                }

                const result = await response.json();

                if (result.success) {
                    
                    contactValueElement.innerText = newContact;
                    addressValueElement.innerText = newAddress;

                    modal.modal('hide');
                    showCustomMessage('Success!', result.message, 'success');
                } else {
                    const errorMessage = result.message || 'The update failed due to a server-side issue.';
                    showCustomMessage('Update Failed!', errorMessage, 'danger');
                }
            } catch (error) {
                console.error('Fetch/Network Error:', error);
                showCustomMessage('Error!', 'Network or server error occurred.', 'danger');
            } finally {
                saveButton.disabled = false;
                saveButton.innerHTML = 'Save Changes';
            }
        });
    });
</script>

